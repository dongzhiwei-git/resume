{{ template "header.html" . }}
<div class="container" style="padding: 2rem 0;">

    {{ template "resume_content.html" . }}

    <div class="no-print" style="text-align: center; margin-top: 2rem;">
        <input type="hidden" name="avatar_existing" value="{{ .Resume.Avatar }}">
        <button id="download-btn" onclick="downloadPdf()" data-i18n="preview_btn"
            style="background: #007bff; color: white; border: none; padding: 1rem 2rem; border-radius: 5px; cursor: pointer; font-size: 1.1rem; margin-right: 1rem;">下载
            PDF</button>
        <button onclick="exportJson()"
            style="background: #17a2b8; color: white; border: none; padding: 1rem 2rem; border-radius: 5px; cursor: pointer; font-size: 1.1rem; margin-right: 1rem;">导出数据
            (JSON)</button>
        <div style="margin-top: 1rem; color: #666; font-size: 0.9rem;">(提示: 关闭此标签页以返回编辑)</div>
    </div>
    <script type="application/json" id="resume-data">{{ .ResumeJSON }}</script>
</div>

<script>
    async function downloadPdf() {
        const btn = document.getElementById('download-btn');
        if (btn) btn.disabled = true;
        try {
            const el = document.getElementById('resume-data');
            const resumeData = JSON.parse(el.textContent || '{}');
            const resp = await fetch('/download/pdf', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(resumeData)
            });
            if (!resp.ok) throw new Error('PDF failed');
            const blob = await resp.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'resume.pdf';
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
            const r = await fetch('/metrics/snapshot');
            const m = await r.json();
            const ge = document.getElementById('generates-count');
            const vi = document.getElementById('visits-count');
            if (ge && typeof m.generates === 'number') ge.textContent = String(m.generates);
            if (vi && typeof m.visits === 'number') vi.textContent = String(m.visits);
        } catch (e) { }
        if (btn) btn.disabled = false;
    }

    function exportJson() {
        const el = document.getElementById('resume-data');
        const resumeData = JSON.parse(el.textContent || '{}');
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(resumeData, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "resume_" + (resumeData.Name || "data") + ".json");
        document.body.appendChild(downloadAnchorNode); // required for firefox
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }
</script>
{{ template "footer.html" . }}